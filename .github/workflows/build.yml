name: Build Shellman RPM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:

  build-rpm:
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          dnf install -y python3 python3-pip rpm-build
          pip install pyinstaller textual

      - name: Build binary
        run: |
          pyinstaller --onefile --collect-all rich --collect-all textual --name shellman file_manager.py

      - name: Create RPM spec file
        run: |
          mkdir -p ~/rpmbuild/{SPECS,SOURCES,BUILD,RPMS,SRPMS}
          cp dist/shellman ~/rpmbuild/SOURCES/
          cat > ~/rpmbuild/SPECS/shellman.spec << EOF
          Name:       shellman
          Version:    1.0.0
          Release:    1%{?dist}
          Summary:    A user friendly Terminal based file manager and editor
          License:    MIT
          
          %description
          A user friendly Terminal based file manager and editor built with Textual.
          
          %install
          mkdir -p %{buildroot}/usr/local/bin
          cp %{_sourcedir}/shellman %{buildroot}/usr/local/bin/shellman
          chmod 755 %{buildroot}/usr/local/bin/shellman
          
          %files
          /usr/local/bin/shellman
          
          %changelog
          * $(date "+%a %b %d %Y") Its-Atharva-Gupta <itsatharva.gupta@gmail.com> - 1.0.0-1
          - Initial release
          EOF

      - name: Build RPM
        run: |
          rpmbuild -bb ~/rpmbuild/SPECS/shellman.spec
          find ~/rpmbuild/RPMS -name "*.rpm"

      - name: Upload .rpm
        uses: actions/upload-artifact@v4
        with:
          name: shellman-fedora.rpm
          path: ~/rpmbuild/RPMS/**/*.rpm